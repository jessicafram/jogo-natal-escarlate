<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Natal Escarlate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=UnifrakturMaguntia&display=swap"
        rel="stylesheet">
    <style>
        body {
            background-image: url('mansao.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #cbd5e0;
            font-family: 'Cormorant Garamond', serif;
        }

        .container {
            background-color: rgba(26, 32, 44, 0.95);
            border: 1px solid #718096;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }

        .game-title {
            color: #e53e3e;
            border-bottom: 1px solid #718096;
            font-family: 'UnifrakturMaguntia', cursive;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .scene-title {
            font-family: 'Cormorant Garamond', serif;
            color: #f6e05e;
        }

        .btn-principal {
            background-color: #c53030;
            transition: background-color 0.3s;
        }

        .btn-principal:hover {
            background-color: #9b2c2c;
        }

        .caderno {
            background-color: #fdfaf3;
            color: #3a2d21;
            border: 1px solid #c7bca1;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5);
        }

        .caderno-titulo {
            font-family: 'UnifrakturMaguntia', cursive;
            color: #5a4b40;
        }

        .objetivo-concluido {
            color: #48bb78;
            /* Verde */
            font-weight: bold;
        }

        .clickable-area {
            position: absolute;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 224, 0.0);
            /* Invisível por padrão */
        }

        .clickable-area:hover {
            background-color: rgba(255, 255, 224, 0.4);
            box-shadow: 0 0 15px #f6e05e;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fdfaf3;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #c7bca1;
            width: 90%;
            max-width: 500px;
            color: #3a2d21;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .character-card {
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }

        .character-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #f6e05e;
            border-color: #f6e05e;
        }

        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #4A5568 !important;
        }

        .interrogation-btn {
            background-color: #4A5568;
        }

        .interrogation-btn:hover:not(.disabled) {
            background-color: #2D3748;
        }

        .interrogation-btn.disabled {
            background-color: #2D3748;
            opacity: 0.5;
            cursor: not-allowed;
        }

        #music-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background-color: rgba(26, 32, 44, 0.8);
            color: #f6e05e;
            border: 1px solid #718096;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        #music-toggle:hover {
            background-color: #2D3748;
            transform: scale(1.1);
        }
    </style>
</head>

<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <button id="music-toggle">
        <svg id="music-on-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 18V5l12-2v13"></path>
            <circle cx="6" cy="18" r="3"></circle>
            <circle cx="18" cy="16" r="3"></circle>
        </svg>
        <svg id="music-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="hidden">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
        </svg>
    </button>

    <div id="game-window" class="max-w-5xl w-full mx-auto p-6 rounded-lg container">
    </div>

    <div id="modal-container" class="modal">
        <div class="modal-content">
            <span onclick="fecharModal()"
                class="float-right text-3xl font-bold cursor-pointer hover:text-red-600">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        // --- BASE DE DADOS DA HISTÓRIA ---
        const storyData = {
            assassino: "Sophia (A Sócia)",
            arma: "Agulha com Veneno",
            motivo: "Vingança",
            suspeitos: {
                "Eleonora (A Viúva)": { retrato: "eleonora.png", descricaoConexao: "A ambiciosa esposa da vítima, com um segredo.", motivo: "Ganância e paixão.", alibi: "Passei a noite no meu quarto com dor de cabeça." },
                "Júnior (O Filho)": { retrato: "junior.png", descricaoConexao: "O filho da vítima, desesperado por dinheiro.", motivo: "Desespero financeiro.", alibi: "Estava no salão de jogos a beber sozinho." },
                "Beatriz (A Filha)": { retrato: "beatriz.png", descricaoConexao: "A filha devota, que faria tudo para proteger quem ama.", motivo: "Proteger o seu amor.", alibi: "Estava no meu quarto a ouvir música." },
                "Dr. Arnaldo (O Médico)": { retrato: "arnaldo.png", descricaoConexao: "O médico da família, apaixonado pela viúva.", motivo: "Paixão por Eleonora.", alibi: "Estava no meu consultório." },
                "Sophia (A Sócia)": { retrato: "sophia.png", descricaoConexao: "A sócia de negócios que Alistair levou à ruína.", motivo: "Vingança pela ruína da sua família.", alibi: "Estava na biblioteca a ler.", segredo: "Ela cria aves exóticas raras como hobby." },
                "Alfredo (O Mordomo)": { retrato: "alfredo.png", descricaoConexao: "O mordomo leal, que sabe mais do que aparenta.", motivo: "Chantagem e proteção.", alibi: "Estava na sala de jantar a polir a prataria por volta das 22h." },
                "Celeste (A Governanta)": { retrato: "celeste.png", descricaoConexao: "A governanta que encontrou o corpo e parece abalada.", motivo: "Vingança pessoal.", alibi: "Estava na cozinha a preparar o pequeno-almoço." }
            },
            dialogos: {
                "Sophia (A Sócia)": [
                    { pergunta: "Onde a senhora estava na noite do crime?", resposta: "Sophia: 'Como já disse, na biblioteca. A leitura acalma a alma.'" },
                    { pergunta: "Encontrei este gravador com o seu nome no escritório.", resposta: "Sophia: 'Ah, o meu gravador... Alistair pediu-mo emprestado. Se quer saber de problemas, fale com o filho dele, Júnior. Vi uma carta com ar ameaçador na gaveta da escrivaninha dele.'", requerPista: "Nome 'Sophia'", acao: (estado) => estado.sophiaMencionouCarta = true },
                    { pergunta: "Alfredo viu-a a sair do consultório do médico. O que fazia lá?", resposta: "Sophia: 'Que absurdo! Fui apenas buscar um analgésico que a pobre Eleonora me pediu. Ela estava com uma enxaqueca terrível.'", requerPista: "Alfredo viu Sophia", acao: (estado) => estado.sophiaMencionouEleonora = true }
                ],
                "Júnior (O Filho)": [
                    { pergunta: "Onde você estava na noite do crime?", resposta: "Júnior: 'Eu estava no salão de jogos a beber sozinho. Fiquei lá até de madrugada.'" },
                    { pergunta: "Encontrei esta carta. Os agiotas estão a pressioná-lo?", resposta: "Júnior: 'Está bem, eu confesso... Eu saí pela janela para me encontrar com eles. Mas eu não o matei! Juro! Mas... eu vi Alfredo a rondar o corredor de forma suspeita essa noite.'", requerPista: "Carta de Ameaça", revelaPista: "Álibi de Júnior quebrado" }
                ],
                "Alfredo (O Mordomo)": [
                    { pergunta: "Qual é o seu álibi?", resposta: "Alfredo: 'Eu estava na sala de jantar a polir a prataria, por volta das 22h.'" },
                    { pergunta: "Júnior disse que o viu a rondar o corredor. O que me diz?", resposta: "Alfredo: 'O menino Júnior tem a língua solta... Eu apenas estava a verificar as portas. Mas já que insiste, eu vi a D. Sophia a sair da biblioteca muito tarde. Ela parecia esconder algo sob o xale. Tinha uma cor... estranha, iridescente.'", requerPista: "Álibi de Júnior quebrado", acao: (estado) => estado.alfredoMencionouSophia = true },
                    { pergunta: "A foto da festa mostra que já passava das 23h. Onde você realmente estava?", resposta: "Alfredo: 'Fui descoberto... Eu não estava a polir a prata. Eu estava com a menina Beatriz.'", requerPista: "Álibi de Alfredo quebrado" },
                    { pergunta: "Você viu mais alguma coisa suspeita?", resposta: "Alfredo: 'Agora que o senhor fala... Vi a D. Sophia a sair sorrateiramente do consultório do Dr. Arnaldo. Achei estranho...'", requerPista: "Veneno de Serpente", revelaPista: "Alfredo viu Sophia" }
                ],
                "Dr. Arnaldo (O Médico)": [
                    { pergunta: "Onde o senhor estava?", resposta: "Dr. Arnaldo: 'No meu consultório. Apenas saí para levar um analgésico a Eleonora.'" },
                    { pergunta: "Posso inspecionar o seu consultório?", resposta: "Dr. Arnaldo: 'Claro, não tenho nada a esconder.'", revelaPista: "Veneno de Serpente" }
                ],
                "Celeste (A Governanta)": [
                    { pergunta: "Onde a senhora estava na hora do crime?", resposta: "Celeste: 'Na cozinha, a preparar o pequeno-almoço para a manhã de Natal. Uma tragédia, uma tragédia...'" },
                    { pergunta: "Esta pena exótica parece-lhe familiar?", resposta: "Celeste: 'Oh, sim! Sem querer fazer intriga, mas a Dona Sophia tem uma fazenda no campo onde cria aves exóticas. Já a vi com penas muito parecidas nos seus chapéus.'", requerPista: "Pena Exótica", revelaPista: "Conexão da Pena" }
                ],
                "Eleonora (A Viúva)": [
                    { pergunta: "Onde a senhora estava na noite do crime?", resposta: "Eleonora: 'No meu quarto, com uma terrível dor de cabeça. O Dr. Arnaldo até me trouxe um analgésico.'" },
                    { pergunta: "A Sophia disse que foi buscar um analgésico para si. É verdade?", resposta: "Eleonora: 'O quê? Não! Eu não pedi nada à Sophia. O Dr. Arnaldo já me tinha ajudado. Por que é que ela diria uma coisa dessas?'", requerPista: "Sophia mencionou Eleonora", revelaPista: "Álibi de Sophia quebrado" }
                ]
            },
            pistas: {
                "Gravador Digital": { imagem: "gravador_digital.png", descricao: "Um pequeno gravador de áudio. A sua única gravação é um som agudo e curto." },
                "Carta de Ameaça": { imagem: "bilhete.png", descricao: "Uma carta de um agiota ameaçando Júnior se ele não pagar as suas dívidas de jogo." },
                "Pena Exótica": { imagem: "pena_exotica.png", descricao: "Uma pena iridescente, azul e verde. Parece pertencer a uma ave muito rara. A pista crucial." },
                "Veneno de Serpente": { imagem: "veneno.png", descricao: "Um frasco de veneno de serpente encontrado no consultório do Dr. Arnaldo. Uma pista falsa?" },
                "Álibi de Alfredo quebrado": { imagem: "festa.png", descricao: "A foto da festa prova que Alfredo mentiu sobre a hora em que estava a polir a prata." },
                "Álibi de Júnior quebrado": { imagem: "bilhete.png", descricao: "Júnior confessou que mentiu sobre o seu álibi. Ele não estava no salão de jogos, mas sim a encontrar-se com agiotas." },
                "Nome 'Sophia'": { descricao: "A análise do áudio do gravador revelou uma mensagem ultrassónica. Decodificada, diz 'SOPHIA'." },
                "Artigo de Jornal": { descricao: "Um antigo artigo de jornal detalha a ruína da família de Sophia causada por Alistair, mencionando a lenda do 'Fantasma do Natal'." },
                "Chave Mestra": { imagem: "chave_mestra.png", descricao: "Uma antiga chave mestra ornamentada. Deve abrir qualquer porta na mansão." },
                "Conexão da Pena": { imagem: "pena_exotica.png", descricao: "Celeste revelou que Sophia cria aves exóticas na sua fazenda, o que liga a Pena Exótica encontrada no escritório diretamente a ela." },
                "Alfredo viu Sophia": { descricao: "Alfredo testemunhou ter visto Sophia a sair do consultório do Dr. Arnaldo na noite do crime." },
                "Sophia mencionou Eleonora": { descricao: "Sophia alega que foi ao consultório do médico a pedido de Eleonora para buscar um analgésico." },
                "Álibi de Sophia quebrado": { imagem: "eleonora.png", descricao: "Eleonora desmentiu a história de Sophia sobre o analgésico, provando que Sophia mentiu sobre estar no consultório do Dr. Arnaldo." }
            }
        };

        let gameState = {};
        const gameWindow = document.getElementById('game-window');
        const modalContainer = document.getElementById('modal-container');
        const modalBody = document.getElementById('modal-body');

        // --- CONTROLO DE MÚSICA DINÂMICO ---
        const musicTracks = {
            suspense: "https://cdn.pixabay.com/download/audio/2022/11/17/audio_8741381364.mp3",
            festa: "https://cdn.pixabay.com/download/audio/2022/01/21/audio_3212b4b048.mp3",
            tensao: "https://cdn.pixabay.com/download/audio/2022/08/04/audio_34e6e06915.mp3"
        };
        let currentTrack;
        let isMusicPlaying = false;
        let isAudioContextStarted = false;
        const musicToggleButton = document.getElementById('music-toggle');
        const musicOnIcon = document.getElementById('music-on-icon');
        const musicOffIcon = document.getElementById('music-off-icon');

        async function initAudioContext() {
            if (isAudioContextStarted) return;
            try {
                await Tone.start();
                isAudioContextStarted = true;
                console.log("Audio Context Started.");
                if (isMusicPlaying) {
                    const initialMood = gameState.cenaAtual ? (gameState.cenaAtual.includes('interrogatorio') ? 'tensao' : (gameState.cenaAtual === 'salao' ? 'festa' : 'suspense')) : 'suspense';
                    await changeMusic(initialMood);
                }
            } catch (e) {
                console.error("Could not start audio context:", e);
            }
        }
        document.body.addEventListener('click', initAudioContext, { once: true });


        async function changeMusic(mood) {
            if (!isAudioContextStarted) return;

            const trackUrl = musicTracks[mood];
            if (currentTrack && currentTrack.buffer.url.includes(trackUrl)) {
                if (isMusicPlaying && currentTrack.state !== 'started') {
                    currentTrack.start();
                }
                return;
            }

            if (currentTrack) {
                currentTrack.stop();
                currentTrack.dispose();
            }

            currentTrack = new Tone.Player({
                url: trackUrl,
                loop: true,
                fadeOut: 0.5,
                fadeIn: 0.5,
                volume: -12
            }).toDestination();

            await Tone.loaded();
            if (isMusicPlaying) {
                currentTrack.start();
            }
        }

        musicToggleButton.addEventListener('click', () => {
            isMusicPlaying = !isMusicPlaying;

            if (!isAudioContextStarted) {
                // Se o contexto ainda não iniciou, apenas atualiza o ícone.
                // O som começará no primeiro clique em qualquer lugar do corpo da página.
                if (isMusicPlaying) {
                    musicOnIcon.classList.add('hidden');
                    musicOffIcon.classList.remove('hidden');
                } else {
                    musicOnIcon.classList.remove('hidden');
                    musicOffIcon.classList.add('hidden');
                }
                return;
            }

            if (isMusicPlaying) {
                if (currentTrack) currentTrack.start();
                musicOnIcon.classList.add('hidden');
                musicOffIcon.classList.remove('hidden');
            } else {
                if (currentTrack) currentTrack.stop();
                musicOnIcon.classList.remove('hidden');
                musicOffIcon.classList.add('hidden');
            }
        });


        function initGame() {
            gameState = {
                currentScreen: 'inicio', protagonista: null, dia: 1,
                objetivo: "Encontre uma forma de entrar no escritório trancado.",
                objetivosConcluidos: new Set(),
                cenaAtual: 'corredor', pistas: new Set(), interrogatorios: {},
                escritorioTrancado: true,
                sophiaMencionouCarta: false,
                alfredoMencionouSophia: false,
                sophiaMencionouEleonora: false
            };
            Object.keys(storyData.suspeitos).forEach(id => {
                gameState.interrogatorios[id] = {
                    interrogado: false,
                    perguntasFeitas: new Set(),
                    ultimaResposta: null
                };
            });
            if (isMusicPlaying) changeMusic('suspense');
            render();
        }

        function render() {
            let content = '';
            switch (gameState.currentScreen) {
                case 'inicio': content = renderTelaInicial(); break;
                case 'jogo': content = renderTelaJogo(); break;
                case 'final': content = renderTelaFinal(); break;
            }
            gameWindow.innerHTML = content;
            if (gameState.currentScreen === 'inicio') typeWriter();
        }

        function renderTelaInicial() {
            return `
                <div class="text-center">
                    <h1 class="text-6xl font-bold mb-4 game-title pb-4">O Natal Escarlate</h1>
                    <div id="narrador-texto" class="text-xl mb-6 h-32 overflow-y-auto border p-4 rounded-md bg-black bg-opacity-20"></div>
                    <div id="escolha-personagem" class="hidden">
                        <p class="text-xl mb-4">Escolha o seu protagonista:</p>
                        <div class="flex flex-col md:flex-row justify-center gap-8">
                            <div onclick="selecionarPersonagem('arthur')" class="character-card text-center p-4 rounded-lg"><img src="arthur.png" alt="O Detetive Arthur Hastings" class="w-48 h-48 mx-auto rounded-full object-cover border-4 border-gray-600"><h3 class="mt-4 text-2xl font-bold">Arthur Hastings</h3></div>
                            <div onclick="selecionarPersonagem('jane')" class="character-card text-center p-4 rounded-lg"><img src="jane.png" alt="A Detetive Jane Marple" class="w-48 h-48 mx-auto rounded-full object-cover border-4 border-gray-600"><h3 class="mt-4 text-2xl font-bold">Jane Marple</h3></div>
                        </div>
                    </div>
                </div>`;
        }

        function renderTelaJogo() {
            return `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="main-panel" class="md:col-span-2">${renderCena()}</div>
                        <div class="md:col-span-1">${renderCaderno()}</div>
                    </div>`;
        }

        function renderTelaFinal() {
            const vitoria = gameState.vitoria;
            return `
                <div class="text-center">
                    <h2 class="text-5xl font-bold game-title pb-4">${vitoria ? "Caso Encerrado!" : "Fim de Jogo"}</h2>
                    <img src="${vitoria ? 'vitoria' : 'derrota'}.png" class="w-full md:w-1/2 mx-auto my-6 rounded-lg shadow-lg">
                    <p class="text-xl">${vitoria ? "Brilhante! Você juntou as pistas certas. Sophia foi desmascarada." : `Enquanto você acusava a pessoa errada, o verdadeiro assassino preparava a sua armadilha final. Você é a última vítima.`}</p>
                    <button onclick="initGame()" class="mt-6 btn-principal text-white font-bold py-3 px-6 rounded text-lg">Jogar Novamente</button>
                </div>`;
        }

        function renderCena() {
            const imagensCena = {
                corredor: 'corredor.png',
                escritorio: 'escritorio.png',
                salao: 'festa.png',
                biblioteca: 'biblioteca.png'
            };

            switch (gameState.cenaAtual) {
                case 'corredor':
                    changeMusic('suspense');
                    return `
                        <h1 class="text-4xl font-bold mb-4 text-center scene-title pb-4 border-b">Corredor do Segundo Andar</h1>
                        <p class="mb-4">A manhã de Natal começa com um grito. Você corre para o corredor e encontra a governanta, Celeste, em pânico em frente à porta do escritório de Alistair. A porta está trancada por dentro.</p>
                        <img src="${imagensCena.corredor}" alt="Porta do escritório" class="rounded-md w-full">
                        <p class="text-xl font-bold text-yellow-400 mt-6 text-center">Dia ${gameState.dia}: ${gameState.objetivo}</p>
                        <button onclick="carregarCena('salao')" class="mt-4 w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded">Ir para o Salão Principal e falar com os outros</button>
                    `;
                case 'escritorio':
                    changeMusic('suspense');
                    let pistasEscritorio = `<div onclick="investigar('Gravador Digital')" class="clickable-area" style="top: 80%; left: 60%;"></div>`;
                    if (gameState.sophiaMencionouCarta && !gameState.pistas.has('Carta de Ameaça')) {
                        pistasEscritorio += `<div onclick="investigar('Carta de Ameaça')" class="clickable-area" style="top: 90%; left: 25%;"></div>`;
                    }
                    return `
                        <h1 class="text-4xl font-bold mb-4 text-center scene-title pb-4 border-b">Cena do Crime: O Escritório</h1>
                        <p class="mb-4">O corpo de Alistair está na poltrona. Não há sinais de luta, apenas uma pequena marca no pescoço. Passe o rato sobre a imagem para encontrar pistas.</p>
                        <div class="relative">
                            <img src="${imagensCena.escritorio}" alt="Cena do crime" class="rounded-md w-full">
                            ${pistasEscritorio}
                        </div>
                        <button onclick="carregarCena('salao')" class="mt-4 w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded">Ir para o Salão Principal</button>
                    `;
                case 'salao':
                    changeMusic('festa');
                    let salaoDesc = "Os suspeitos estão reunidos aqui, tensos.";
                    if (!gameState.escritorioTrancado) {
                        salaoDesc += " Consulte os dossiês no seu caderno para iniciar um interrogatório.";
                    }

                    let clickableKeyArea = '';
                    if (gameState.pistas.has('Artigo de Jornal') && gameState.escritorioTrancado) {
                        clickableKeyArea = `<div onclick="encontrarChaveMestra()" class="clickable-area" style="top: 30%; left: 15%; width: 50px; height: 50px;"></div>`;
                    }

                    return `
                        <h1 class="text-4xl font-bold mb-4 text-center scene-title pb-4 border-b">Salão Principal</h1>
                        <p class="mb-4">${salaoDesc}</p>
                        <div class="relative">
                            <img src="${imagensCena.salao}" alt="Salão da festa" class="rounded-md w-full" id="foto-festa">
                            ${clickableKeyArea}
                        </div>
                         <button onclick="analisarFotoFesta()" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded ${gameState.dia < 2 ? 'disabled' : ''}" ${gameState.dia < 2 ? 'disabled' : ''}>Analisar Foto da Festa</button>
                         <button onclick="carregarCena('escritorio')" class="mt-4 w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded ${gameState.escritorioTrancado ? 'disabled' : ''}" ${gameState.escritorioTrancado ? 'disabled' : ''}>Ir para o Escritório</button>
                         <button onclick="carregarCena('biblioteca')" class="mt-4 w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded">Ir para a Biblioteca</button>
                    `;
                case 'biblioteca':
                    changeMusic('suspense');
                    let pistasBiblioteca = '';
                    if (gameState.alfredoMencionouSophia) {
                        pistasBiblioteca += `<button onclick="investigar('Pena Exótica')" class="mt-4 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">Investigar o xale de Sophia</button>`;
                    }
                    return `
                        <h1 class="text-4xl font-bold mb-4 text-center scene-title pb-4 border-b">Biblioteca</h1>
                        <p class="mb-4">Uma sala silenciosa e cheia de livros antigos. Você nota uma coleção de jornais antigos numa mesa de canto, e o xale de Sophia esquecido numa poltrona.</p>
                        <div class="relative">
                            <img src="${imagensCena.biblioteca}" alt="Biblioteca da mansão" class="rounded-md w-full">
                            <div onclick="investigar('Artigo de Jornal')" class="clickable-area" style="top: 85%; left: 70%;"></div>
                        </div>
                        ${pistasBiblioteca}
                        <button onclick="carregarCena('salao')" class="mt-4 w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded">Voltar ao Salão</button>
                    `;
            }
        }

        function renderCaderno() {
            let pistasHTML = '';
            if (gameState.pistas.size === 0) {
                pistasHTML = `<li class="opacity-50">Nenhuma pista ainda...</li>`;
            } else {
                const pistasOrdenadas = Array.from(gameState.pistas).filter(p => storyData.pistas[p] && !storyData.pistas[p].descricao.includes("testemunhou") && !storyData.pistas[p].descricao.includes("alega"));
                pistasOrdenadas.forEach(pista => {
                    pistasHTML += `<li class="cursor-pointer hover:text-yellow-700" onclick="mostrarPista('${pista}')">${pista}</li>`;
                });
            }

            let suspeitosHTML = '';
            Object.keys(storyData.suspeitos).forEach(id => {
                suspeitosHTML += `<button onclick="abrirDossie('${id}')" class="w-full text-left p-2 rounded hover:bg-yellow-100 border-b">${id}</button>`;
            });

            let acusacaoAtivada = gameState.dia >= 3;

            let objetivosHTML = '';
            const objetivosOrdenados = Array.from(gameState.objetivosConcluidos);
            objetivosOrdenados.forEach(obj => {
                objetivosHTML += `<p class="text-sm italic objetivo-concluido">${obj}</p>`;
            });
            objetivosHTML += `<p class="text-sm italic text-yellow-700 font-bold">${gameState.objetivo}</p>`;


            return `
                <div class="caderno p-4 rounded-md h-full">
                    <h2 class="text-3xl text-center caderno-titulo pb-2 border-b-2 border-gray-400">Caderno do Detetive</h2>
                    <h3 class="font-bold mt-4 text-lg">Objetivos (Dia ${gameState.dia}):</h3>
                    <div class="space-y-1">${objetivosHTML}</div>
                    <h3 class="font-bold mt-4 text-lg">Pistas:</h3>
                    <ul class="list-disc list-inside text-sm min-h-[100px]">${pistasHTML}</ul>
                    <h3 class="font-bold mt-6 text-lg">Suspeitos:</h3>
                    <div class="space-y-2 mt-2">${suspeitosHTML}</div>
                    <h3 class="font-bold mt-6 text-lg">Minha Acusação Final:</h3>
                    <div class="${!acusacaoAtivada ? 'disabled' : ''}">
                        <select id="select-suspeito" class="w-full p-2 bg-white text-black border border-gray-400 rounded mt-2" ${!acusacaoAtivada ? 'disabled' : ''}><option>Assassino...</option>${Object.keys(storyData.suspeitos).map(id => `<option>${id}</option>`).join('')}</select>
                        <select id="select-arma" class="w-full p-2 bg-white text-black border border-gray-400 rounded mt-2" ${!acusacaoAtivada ? 'disabled' : ''}><option>Arma...</option><option>Faca</option><option>Agulha com Veneno</option><option>Pena Exótica</option><option>Carta de Ameaça</option></select>
                        <select id="select-motivo" class="w-full p-2 bg-white text-black border border-gray-400 rounded mt-2" ${!acusacaoAtivada ? 'disabled' : ''}><option>Motivo...</option><option>Ganância</option><option>Vingança</option><option>Paixão</option></select>
                        <button onclick="fazerAcusacao()" class="mt-4 w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded" ${!acusacaoAtivada ? 'disabled' : ''}>Fazer Acusação</button>
                    </div>
                </div>`;
        }

        function typeWriter() {
            const texto = "Você foi convidado para a festa de Natal na Mansão dos Van der Bergh...";
            let i = 0;
            const el = document.getElementById('narrador-texto');
            if (!el) return;
            function escrever() {
                if (i < texto.length) { el.innerHTML += texto.charAt(i); i++; setTimeout(escrever, 40); }
                else {
                    document.getElementById('escolha-personagem').classList.remove('hidden');
                }
            }
            escrever();
        }

        function selecionarPersonagem(nome) {
            gameState.protagonista = nome;
            gameState.currentScreen = 'jogo';
            render();
        }

        function carregarCena(nomeCena) { gameState.cenaAtual = nomeCena; render(); }

        function proximoObjetivo(novoObjetivo) {
            if (gameState.objetivo !== novoObjetivo && !gameState.objetivosConcluidos.has(novoObjetivo)) {
                gameState.objetivosConcluidos.add(gameState.objetivo);
                gameState.objetivo = novoObjetivo;
            }
        }

        function investigar(nomePista) {
            if (gameState.pistas.has(nomePista)) { mostrarPista(nomePista); return; }

            adicionarPista(nomePista);

            if (nomePista === 'Artigo de Jornal') {
                alert("Você encontrou um artigo de jornal antigo sobre a ruína de uma família... O artigo menciona a lenda de um assassino em série, o 'Fantasma do Natal', que deixava uma chave mestra escondida perto do retrato do fundador da casa. Você deve procurar pelo retrato no salão principal!");
                proximoObjetivo("Encontre a chave mestra no salão principal.");
            } else if (nomePista === 'Gravador Digital') {
                proximoObjetivo("Analise o gravador no seu caderno.");
            } else if (nomePista === 'Carta de Ameaça') {
                proximoObjetivo("Confronte Júnior sobre a carta de ameaça.");
            } else if (nomePista === 'Pena Exótica') {
                proximoObjetivo("Descubra a origem da pena exótica.");
            }

            mostrarPista(nomePista);
            render();
        }

        function encontrarChaveMestra() {
            alert("Você encontrou a chave mestra escondida atrás do retrato do fundador!");
            adicionarPista("Chave Mestra");
            gameState.escritorioTrancado = false;
            proximoObjetivo("Use a chave mestra para entrar no escritório.");
            render();
        }

        function abrirDossie(suspeitoId) {
            gameState.interrogatorios[suspeitoId].ultimaResposta = null;
            const suspeito = storyData.suspeitos[suspeitoId];
            let content = `
                <div id="dossie-view">
                    <h2 class="text-3xl text-center caderno-titulo pb-2">${suspeitoId}</h2>
                    <img src="${suspeito.retrato}" alt="Retrato de ${suspeitoId}" class="w-32 h-32 mx-auto my-4 rounded-full object-cover border-4 border-gray-400">
                    <p class="text-center italic mb-4">"${suspeito.descricaoConexao}"</p>
                    <button onclick="renderInterrogatorioNoModal('${suspeitoId}')" class="mt-6 w-full btn-principal text-white font-bold py-2 px-4 rounded">Interrogar</button>
                </div>`;

            modalBody.innerHTML = content;
            modalContainer.style.display = 'block';
        }

        function renderInterrogatorioNoModal(suspeitoId) {
            changeMusic('tensao');
            const suspeito = storyData.suspeitos[suspeitoId];
            let perguntasHTML = '';
            const dialogosDisponiveis = storyData.dialogos[suspeitoId] || [{ pergunta: "Qual o seu álibi?", resposta: `"${storyData.suspeitos[suspeitoId].alibi}"` }];

            dialogosDisponiveis.forEach((dialogo, index) => {
                const jaPerguntado = gameState.interrogatorios[suspeitoId].perguntasFeitas.has(index);
                const desativado = dialogo.requerPista && !gameState.pistas.has(dialogo.requerPista);
                perguntasHTML += `
                    <button onclick="fazerPerguntaNoModal('${suspeitoId}', ${index})" 
                            class="w-full text-left p-2 rounded text-white interrogation-btn ${jaPerguntado ? 'opacity-50' : ''} ${desativado ? 'disabled' : ''}"
                            ${desativado ? 'disabled' : ''}>
                        ${dialogo.pergunta} ${desativado ? ' (Requer Pista)' : ''}
                    </button>`;
            });

            const respostaAtual = gameState.interrogatorios[suspeitoId].ultimaResposta || "Selecione uma pergunta para fazer.";

            const interrogatorioHTML = `
                <h2 class="text-3xl text-center caderno-titulo pb-2">${suspeitoId}</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center mb-4">
                    <div class="md:col-span-1 flex justify-center">
                        <img src="${suspeito.retrato}" alt="Retrato de ${suspeitoId}" class="w-24 h-24 rounded-full object-cover border-4 border-gray-400">
                    </div>
                    <div class="md:col-span-2 text-sm">
                        <p class="italic">"${suspeito.descricaoConexao}"</p>
                        <h4 class="font-bold mt-2">Álibi Declarado:</h4>
                        <p class="italic">"${suspeito.alibi}"</p>
                    </div>
                </div>
                <div id="dialogo-resposta-modal" class="p-4 bg-gray-800 text-white rounded-md min-h-[80px] italic text-center mb-4 flex items-center justify-center">${respostaAtual}</div>
                <div class="space-y-2">${perguntasHTML}</div>
            `;
            modalBody.innerHTML = interrogatorioHTML;
        }

        function fecharModal() {
            modalContainer.style.display = 'none';
            changeMusic('festa'); // Volta para a música do salão ao fechar o modal de interrogatório
        }

        function fazerPerguntaNoModal(suspeitoId, index) {
            const dialogos = storyData.dialogos[suspeitoId] || [{ pergunta: "Qual o seu álibi?", resposta: `"${storyData.suspeitos[suspeitoId].alibi}"` }];
            const dialogo = dialogos[index];

            gameState.interrogatorios[suspeitoId].ultimaResposta = dialogo.resposta;
            gameState.interrogatorios[suspeitoId].perguntasFeitas.add(index);

            if (dialogo.acao) dialogo.acao(gameState);

            if (dialogo.revelaPista) {
                adicionarPista(dialogo.revelaPista);
                if (dialogo.revelaPista === "Álibi de Júnior quebrado") {
                    proximoObjetivo("Interrogue Alfredo sobre o que ele viu.");
                } else if (dialogo.revelaPista === "Veneno de Serpente") {
                    mostrarPista("Veneno de Serpente");
                    proximoObjetivo("Pergunte a Alfredo se ele viu algo perto do consultório.");
                    return;
                } else if (dialogo.revelaPista === "Conexão da Pena") {
                    alert("Pista crucial encontrada! Celeste conectou a pena a Sophia.");
                    proximoObjetivo("Confronte Alfredo sobre a foto da festa para quebrar o seu álibi.")
                } else if (dialogo.revelaPista === "Alfredo viu Sophia") {
                    proximoObjetivo("Confronte Sophia sobre a sua visita ao consultório do médico.");
                } else if (dialogo.revelaPista === "Álibi de Sophia quebrado") {
                    alert("O álibi de Sophia foi quebrado! Ela mentiu para incriminar o médico.");
                    proximoObjetivo("Você tem provas suficientes contra Sophia. Avance para o Dia 3.");
                }
            }

            if (suspeitoId === 'Alfredo (O Mordomo)' && dialogo.pergunta.includes('foto da festa')) {
                if (!gameState.pistas.has("Álibi de Sophia quebrado")) {
                    proximoObjetivo("Investigue a tentativa de Sophia de incriminar o Dr. Arnaldo.");
                } else if (!gameState.pistas.has("Conexão da Pena")) {
                    proximoObjetivo("Descubra a origem da pena exótica.");
                } else {
                    proximoObjetivo("Reúna as suas conclusões para a acusação final.");
                }
            }

            if (dialogo.acao && suspeitoId === "Sophia (A Sócia)") {
                if (gameState.sophiaMencionouEleonora) {
                    adicionarPista("Sophia mencionou Eleonora");
                    proximoObjetivo("Confirme a história de Sophia com Eleonora.");
                } else {
                    proximoObjetivo("Investigue a escrivaninha no escritório em busca de uma carta.");
                }
            } else if (dialogo.acao && suspeitoId === "Alfredo (O Mordomo)") {
                proximoObjetivo("Procure por algo incomum na biblioteca.");
            }

            renderInterrogatorioNoModal(suspeitoId);
            render();
        }

        function adicionarPista(nomePista) {
            if (gameState.pistas.has(nomePista)) return;
            gameState.pistas.add(nomePista);
            if (gameState.dia === 1 && gameState.pistas.has("Pena Exótica") && gameState.pistas.has("Carta de Ameaça") && gameState.pistas.has("Nome 'Sophia'")) {
                gameState.dia = 2;
                proximoObjetivo("Interrogue os suspeitos e quebre os seus álibis restantes.");
            } else if (gameState.dia === 2 && gameState.pistas.has("Álibi de Alfredo quebrado") && gameState.pistas.has("Conexão da Pena") && gameState.pistas.has("Álibi de Sophia quebrado")) {
                gameState.dia = 3;
                proximoObjetivo("Você tem pistas suficientes. Faça a sua acusação final.");
            }
        }

        function mostrarPista(nomePista) {
            const pista = storyData.pistas[nomePista];
            if (!pista) {
                console.error("Tentativa de mostrar pista inexistente:", nomePista);
                return;
            }
            const isLogicPista = pista.descricao.includes("testemunhou") || pista.descricao.includes("alega");

            if (isLogicPista) return;

            modalBody.innerHTML = `
                <h2 class="text-3xl text-center caderno-titulo pb-2">${nomePista}</h2>
                ${pista.imagem ? `<img src="${pista.imagem}" alt="Imagem da pista" class="w-full my-4 rounded-md">` : ''}
                <p class="text-center">${pista.descricao}</p>
            `;

            if (nomePista === "Gravador Digital") {
                setTimeout(() => {
                    const audioContent = `<div class="mt-4"><audio id="audio-pista" controls class="w-full"></audio><button onclick="analisarAudio()" class="mt-2 btn-principal text-white font-bold py-2 px-4 rounded w-full">Analisar Áudio</button><div id="mensagem-audio-escondida" class="mt-2 p-2 bg-gray-900 rounded-md text-center hidden"></div></div>`;
                    modalBody.insertAdjacentHTML('beforeend', audioContent);
                    iniciarAudio();
                }, 100);
            }
            modalContainer.style.display = 'block';
        }

        function analisarFotoFesta() {
            if (gameState.dia < 2) return;
            alert("Ao analisar a foto da festa, você nota o reflexo de um relógio no espelho ao fundo. Ele marca 23:15!");
            adicionarPista("Álibi de Alfredo quebrado");
            proximoObjetivo("Confronte Alfredo sobre a foto da festa.");
            render();
        }

        function fazerAcusacao() {
            const suspeito = document.querySelector('#game-window select[id^="select-suspeito"]').value;
            const arma = document.querySelector('#game-window select[id^="select-arma"]').value;
            const motivo = document.querySelector('#game-window select[id^="select-motivo"]').value;

            if (suspeito === "Assassino..." || arma === "Arma..." || motivo === "Motivo...") {
                alert("Você precisa de preencher todos os campos da acusação!"); return;
            }

            const vitoria = suspeito === storyData.assassino && arma === storyData.arma && motivo === storyData.motivo;
            gameState.vitoria = vitoria;
            gameState.currentScreen = 'final';
            render();
        }

        let audioIniciado = false;
        async function iniciarAudio() {
            if (audioIniciado || !isAudioContextStarted) return;
            try {
                const audioPlayer = document.getElementById('audio-pista');
                const synth = new Tone.Synth().toDestination();
                const recorder = new Tone.Recorder();
                synth.connect(recorder);
                recorder.start();
                synth.triggerAttackRelease("C6", "0.5");
                setTimeout(async () => {
                    const recording = await recorder.stop();
                    audioPlayer.src = URL.createObjectURL(recording);
                    audioIniciado = true;
                }, 1000);
            } catch (error) { console.error("Erro no áudio:", error); }
        }

        function analisarAudio() {
            const el = document.getElementById('mensagem-audio-escondida');
            el.classList.remove('hidden');
            el.innerHTML = `<p class="animate-pulse">Analisando...</p>`;
            setTimeout(() => {
                el.innerHTML = `<p>Decodificado: <strong class="text-yellow-400">SOPHIA</strong></p>`;
                adicionarPista("Nome 'Sophia'");
                proximoObjetivo("Confronte Sophia sobre o gravador.");
                render();
            }, 2500);
        }

        initGame();
    </script>
</body>

</html>